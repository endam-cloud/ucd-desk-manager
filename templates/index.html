<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCD Planning Desk Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .table-container { max-height: 400px; overflow-y: auto; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
        .branding-img { max-width: 200px; height: auto; margin-bottom: 20px; }
        .sortable:hover { cursor: pointer; text-decoration: underline; }
        .sort-asc::after { content: ' ↑'; }
        .sort-desc::after { content: ' ↓'; }
        .loading { display: none; margin-top: 10px; }
        .spinner-border { width: 1.5rem; height: 1.5rem; }
        .btn-primary, .btn-danger, .btn-info, .btn-warning, .btn-secondary, .btn-success {
            margin-right: 5px; margin-bottom: 5px; padding: 8px 16px; font-size: 0.9rem;
        }
        .login-status { margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <img src="/static/ucd_logo.png" alt="UCD Logo" class="branding-img">
        <h1 class="mb-4">UCD Planning Desk Management System</h1>
        <div class="login-status">
            {% if authenticated %}
                <p>Logged in as {{ current_user.id }} | <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary btn-sm">Logout</a></p>
            {% else %}
                <p>Not logged in | <a href="{{ url_for('login') }}" class="btn btn-outline-primary btn-sm">Login</a></p>
            {% endif %}
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        {% if authenticated %}
        <form id="deskForm" class="mb-4">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="desk_id" class="form-label">Desk ID (1–40 or new):</label>
                    <input type="number" class="form-control" id="desk_id" name="desk_id" required min="1">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="name" class="form-label">Occupant Name:</label>
                    <input type="text" class="form-control" id="name" name="name">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="arrival" class="form-label">Arrival (YYYY-MM-DD):</label>
                    <input type="date" class="form-control" id="arrival" name="arrival">
                </div>
                <div class="col-md-6">
                    <label for="leaving" class="form-label">Leaving (YYYY-MM-DD):</label>
                    <input type="date" class="form-control" id="leaving" name="leaving">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="location" class="form-label">Location (e.g., Richview Research Hub):</label>
                    <input type="text" class="form-control" id="location" name="location">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="supervisor" class="form-label">Supervisor (e.g., Prof. Murphy):</label>
                    <input type="text" class="form-control" id="supervisor" name="supervisor">
                </div>
                <div class="col-md-6">
                    <label for="status" class="form-label">Status (e.g., PhD, Post-Doc):</label>
                    <input type="text" class="form-control" id="status" name="status">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-12">
                    <button type="button" class="btn btn-primary" onclick="submitAction('add_occupant')">Add Occupant</button>
                    <button type="button" class="btn btn-danger" onclick="submitAction('remove_occupant')">Remove Occupant</button>
                    <button type="button" class="btn btn-info" onclick="submitAction('set_details')">Set/Update Details</button>
                    <button type="button" class="btn btn-warning" onclick="submitAction('add_desk')">Add New Desk</button>
                    <button type="button" class="btn btn-secondary" onclick="listDesks()">List All Desks</button>
                    <button type="button" class="btn btn-success" onclick="findVacantDesks()">Find Vacant Desks</button>
                </div>
            </div>
            <div class="loading" id="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span>Processing...</span>
            </div>
        </form>
        {% else %}
        <div class="alert alert-info">
            Please log in to add or modify desk information. You can still view the desk list below.
        </div>
        <div class="row mb-3">
            <div class="col-md-12">
                <button type="button" class="btn btn-secondary" onclick="listDesks()">List All Desks</button>
                <button type="button" class="btn btn-success" onclick="findVacantDesks()">Find Vacant Desks</button>
            </div>
        </div>
        {% endif %}
        <div id="message" class="mb-3"></div>
        <div class="table-container">
            <table class="table table-bordered table-hover">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortTable('desk_id')">Desk</th>
                        <th class="sortable" onclick="sortTable('occupant')">Occupant</th>
                        <th class="sortable" onclick="sortTable('arrival')">Arrival</th>
                        <th class="sortable" onclick="sortTable('leaving')">Leaving</th>
                        <th class="sortable" onclick="sortTable('location')">Location</th>
                        <th class="sortable" onclick="sortTable('supervisor')">Supervisor</th>
                        <th class="sortable" onclick="sortTable('status')">Status</th>
                        <th>Desk Status</th>
                    </tr>
                </thead>
                <tbody id="deskTable"></tbody>
            </table>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentSort = 'desk_id';
        let currentOrder = 'asc';

        function sortTable(column) {
            if (currentSort === column) {
                currentOrder = currentOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort = column;
                currentOrder = 'asc';
            }
            listDesks();
        }

        function clearForm() {
            document.getElementById('deskForm')?.reset();
        }

        function showLoading(show) {
            const loadingDiv = document.getElementById('loading');
            if (loadingDiv) loadingDiv.style.display = show ? 'block' : 'none';
        }

        function submitAction(action) {
            if (action === 'remove_occupant') {
                if (!confirm('Are you sure you want to remove the occupant from this desk?')) {
                    return;
                }
            }

            showLoading(true);
            const formData = new FormData(document.getElementById('deskForm'));
            const url = action === 'add_desk' ? '/add_desk' : `/${action}`;
            
            fetch(url, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                const messageDiv = document.getElementById('message');
                if (data.error) {
                    messageDiv.className = 'error';
                    messageDiv.textContent = data.error;
                } else {
                    messageDiv.className = 'success';
                    messageDiv.textContent = data.message;
                    clearForm();
                    listDesks();
                }
                setTimeout(() => messageDiv.textContent = '', 5000);
            })
            .catch(error => {
                showLoading(false);
                document.getElementById('message').className = 'error';
                document.getElementById('message').textContent = 'An error occurred: ' + error.message;
                setTimeout(() => document.getElementById('message').textContent = '', 5000);
            });
        }

        function listDesks() {
            showLoading(true);
            fetch(`/list_desks?sort=${currentSort}&order=${currentOrder}`)
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                const tbody = document.getElementById('deskTable');
                tbody.innerHTML = '';
                data.forEach(desk => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${desk.desk_id}</td>
                        <td>${desk.occupant}</td>
                        <td>${desk.arrival}</td>
                        <td>${desk.leaving}</td>
                        <td>${desk.location}</td>
                        <td>${desk.supervisor}</td>
                        <td>${desk.status}</td>
                        <td>${desk.desk_status}</td>
                    `;
                    tbody.appendChild(row);
                });
                // Update sort indicators
                document.querySelectorAll('.sortable').forEach(th => {
                    th.classList.remove('sort-asc', 'sort-desc');
                    if (th.getAttribute('onclick').includes(currentSort)) {
                        th.classList.add(`sort-${currentOrder}`);
                    }
                });
            })
            .catch(error => {
                showLoading(false);
                document.getElementById('message').className = 'error';
                document.getElementById('message').textContent = 'Error loading desks: ' + error.message;
                setTimeout(() => document.getElementById('message').textContent = '', 5000);
            });
        }

        function findVacantDesks() {
            showLoading(true);
            fetch('/find_vacant_desks')
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                const messageDiv = document.getElementById('message');
                if (data.vacant.length === 0) {
                    messageDiv.className = 'success';
                    messageDiv.textContent = 'No vacant desks.';
                } else {
                    const message = data.vacant.map(d => `Desk ${d.desk_id} (${d.location})`).join('\n');
                    messageDiv.className = 'success';
                    messageDiv.textContent = 'Vacant Desks:\n' + message;
                }
                setTimeout(() => messageDiv.textContent = '', 5000);
            })
            .catch(error => {
                showLoading(false);
                document.getElementById('message').className = 'error';
                document.getElementById('message').textContent = 'Error finding vacant desks: ' + error.message;
                setTimeout(() => document.getElementById('message').textContent = '', 5000);
            });
        }

        // Load desks on page load
        window.onload = listDesks;
    </script>
</body>
</html>